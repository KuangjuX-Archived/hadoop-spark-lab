# Spider

## 介绍
我们目前在多个相亲网站上爬取会员信息以调研国内相亲的大数据，在这里我们以世纪佳缘的爬虫为例，来介绍我们的解决方案与技术手段。  

首先我们的爬虫程序，分别使用了单线程和异步来进行爬取(由于 `python` 的 GIL (全局解释器锁) 机制，我们没有采取多线程的技术方案)。单线程主要是为了更关注于爬虫的逻辑的简单实现，而异步则是在单线程的基础上做的进一步优化。  

![](../docs/流程图.png)

### 爬虫流程
在爬取世纪佳缘网站的时候，我们首先进入搜索页可以看到个人信息，打开 `Chrome` 开发者进行了简单的分析，可以发现可以通过一个 `POST` 请求来获取用户的信息，于是我们可以通过模拟规定的 `payload` 的格式向对应的 `API` 发送请求即可获得对应的用户信息，这里我们需要提供一些搜索相关的信息以及对应的 `page_id` 来爬取信息。当获得用户的信息后，我们发现拿到的其实并不是用户的所有信息，要获取到用户的所有信息，我们需要去用户的个人主页去获取，见过简单的分析，我们发现只要能拿到用户的 `realUid` 就可以构造个人主页的 `URL`。  
  
当访问用户的个人主页时，我们可以使用 `GET` 方法拿到用户主页的 `html` 格式的信息，然后通过 `BeautfulSoup` 和 `re` 库的帮助我们可以很轻易地解析出用户全部个人信息。  
  
### 反反爬虫  

然而，网站对于爬虫实际对于爬虫具有一定的反爬虫限制措施。  

#### 滑块验证码
首先，网站对于用户个人主页的访问频率有一定限制，当我们连续访问 10 个个人主页时，网站将会弹出极验验证码让用户识别(即滑块验证)，倘若我们无法通过验证则无法再继续爬取。我们一开始尝试过减慢访问频率和使用 IP 代理池都没有成功。最后我们决定暴力破解滑块验证。  
  
和点触验证码相比，极验验证码其实相对更简单，因为破解点触验证码需要使用深度学习进行训练才可以有较高的识别率，而破解极验验证码只需要获取到拼接前的图片和拼接后的图片，之后进行逐像素的比对即可获取验证码需要滑动的距离。于是我们分析了一下网页的 html 的源代码，发现拼接前和拼接后的图像都被嵌在 `Canvas` 中，于是我们可以使用 `senlenium` + `ChromeDriver` 模拟用户进行操作，首先我们通过执行一段 `JavaScript` 程序拿到 `Canvas` 的图片，然后逐像素比对两张图片的不同，并获取到需要滑动的距离，当我们获取到滑动距离后，我们就可以模拟用户滑动到对应的位置来破解滑块验证。 
  
然而网站事实上对于滑块速度有一定要求，如果你是直接将滑块从开始一直滑到最终位置，一点像素偏差都没有，网站会迅速识别出你是爬虫。于是我们尝试模拟人类的滑动轨迹，我们尝试了具有一定加速度的滑动以及随机暂停的滑动还有一些较为平滑地模拟运动曲线数学公式的公式(这些定义在 `track.py` 里面)，最终我们可以以一种较高的效率破解滑块验证。于是我们在爬取的时候检测到验证码出现的时候进行滑块验证的破解，在破解后继续进行爬取。    
   
#### 模拟用户登录
由于对于网站个人主页的某些信息需要登录后才能查看，因此我们必须模拟出用户登录的 "假象"，从而才能获取到用户的全部信息，因此我们登录后可以从 `Chrome` 检查者中拿到我们的 `Cookie` 之后使用 `requests` 库的 `RequestsCookieJar` 属性将其解析成 `requests` 能够识别的格式，最后每次访问都将 `cookie` 带上即可模拟用户的登录。
  
### 异步
在 `python` 提供了 `asyncio` 这个库实现异步编程，我们可以使用 `async` 和 `await` 来做异步。事实上 `asyncio` 提供的异步为无栈协程，所谓无栈协程即是在用户态实现的轻量级无栈的线程，它使用状态机来实现线程的功能，并由一个 `Runtime` 来实行调度，以充分利用机器的性能，例如，当我们进行网络请求的时候会产生阻塞，因此我们可以把网络请求，标记为 `async`，而在调用网络请求时使用 `await` 来执行异步调用，当网络请求阻塞时，他会立刻调度到其他函数，当网络请求成功后，它将会受到网络请求返回的消息并继续处理，这样就不会在网卡阻塞时占用 `CPU` 的时间，从而充分利用了机器的性能。其中调度的部分全部是由语言内部的 `Runtime` 来做，`async` 和 `await` 是一个语法糖，在运行时翻译成 `Runtime` 的函数。  
  
在我们的实现中，我们实现了使用异步来爬取、解析、持久化等操作，通过在标记为 `async` 的函数中使用 `asyncio.create_task()` 来创建异步任务，并对其执行 `await` 操作即可使其异步运行。由于 `async` 操作具有传染性，所有调用 `async` 的函数都必须是异步函数，因此当我们调用顶层函数时，需要使用 `asyncio.run()` 来执行。

## 引用
- [极验滑动验证码的识别-崔庆才](https://github.com/Python3WebSpider/Python3WebSpider/blob/master/8.2-%E6%9E%81%E9%AA%8C%E6%BB%91%E5%8A%A8%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB.md)
- [Crack the slider verification code of station B with Python + selenium, the road of information security](https://pythonmana.com/2021/08/20210819125058115g.html)
- [极验滑块破解-掘金](https://juejin.cn/post/6844903953595891725)